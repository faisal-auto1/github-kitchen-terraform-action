name: "tf_action_from_comment"

on:
  issue_comment:
    types:
      - created

jobs:
  comment:
    name: read_comment
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.extract.outputs.action }}
      workspace: ${{ steps.extract.outputs.workspace }}
      tfdir: ${{ steps.extract.outputs.tfdir }}

    steps:
      - name: Read comment
        id: extract
        run: |
          body=$(echo "${{ github.event.comment.body }}")
          action=$(echo "${{ github.event.comment.body }}" | awk '{print $1}')
          workspace=$(echo "${{ github.event.comment.body }}" | awk '{print $2}')
          tfdir=$(echo "${{ github.event.comment.body }}" | awk '{print $3}')

          echo "action=$action" >> "$GITHUB_OUTPUT"
          echo "workspace=$workspace" >> "$GITHUB_OUTPUT"
          echo "tfdir=$tfdir" >> "$GITHUB_OUTPUT"

      - name: check step output
        run: |
          echo "First argument: ${{ steps.extract.outputs.action }}"
          echo "Second argument: ${{ steps.extract.outputs.workspace }}"
          echo "Third argument: ${{ steps.extract.outputs.tfdir }}"

  tfplan:
    needs: comment
    runs-on: ubuntu-latest
    name: "tf_action"
    defaults:
      run:
        working-directory: ${{ needs.comment.outputs.tfdir }}
    steps:

      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment-branch

      - name: HashiCorp - Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Checkout
        uses: actions/checkout@v1
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}

      - name: Extract Pull Request Number
        id: extract_pr_number
        run: echo "::set-output name=PR_NUMBER::$(jq -r '.issue.number' $GITHUB_EVENT_PATH)"

      - name: Generate Unique ID
        id: generate_id
        if: steps.check_comment.outputs.TRIGGERED == 'true'
        run: echo "::set-output name=ID::$(date +%Y%m%d%H%M%S)-$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 6 | head -n 1)"

      - name: Plan
        id: plan
        run: |
          set +e
          echo "testDir"
          pwd
          export TF_WORKSPACE=${{ needs.comment.outputs.workspace }}
          if [[ $TF_WORKSPACE == "prod" ]]; then
            unset VAULT_TOKEN
            export VAULT_ADDR=https://vault.prod.auto1.team
            export VAULT_TOKEN="$VAULT_TOKEN_PROD"
          elif [[ $TF_WORKSPACE == "qa" ]]; then
            export VAULT_ADDR=https://vault.qa.auto1.team
            export VAULT_TOKEN="$VAULT_TOKEN_QA"
          else
            unset VAULT_TOKEN
            export VAULT_ADDR=https://vault.prod.auto1.team
            export VAULT_TOKEN="$VAULT_TOKEN_PROD"
          fi

          terraform init -reconfigure > /dev/null 2>&1
          terraform plan -out=tfplan
          terraform show tfplan |& tee tf_plan.txt

        env:
          VAULT_TOKEN_QA: ${{ secrets.VAULT_TOKEN_QA }}
          VAULT_TOKEN_PROD: ${{ secrets.VAULT_TOKEN_PROD }}

        continue-on-error: true

      - name: Save Plan File as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: terraform-plan-${{ steps.generate_id.outputs.ID }}
          path: tfplan

      - name: Comment on Pull Request
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const data = fs.readFileSync('tfplan', 'utf8');
            const { owner, repo } = github.context.repo;
            const prNumber = process.env.PR_NUMBER;
            const octokit = new github.getOctokit(process.env.GITHUB_TOKEN);
            await octokit.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: prNumber,
              body: 'Terraform Plan:\n```' + data + '```\n',
            });
